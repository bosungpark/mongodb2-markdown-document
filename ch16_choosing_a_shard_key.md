Choosing a Shard Key
=

샤딩을 할 때 가장 중요한 요소는 데이터를 어떻게 분산시킬까하는 점이다.
이때 사용되는 것이 shard key이다.
shard key는 한번 정하면 수정할 수 없기 때문에 잘 정해야한다.
일반적으로는 오름차순 혹은 랜덤의 혹은 위치 기반의 키를 많이 사용한다.

Ascending Shard Keys
-
Ascending shard key는 일반적으로 date, ObjectId와 같이 시간에 따라 올라가는 성질을 가진 필드를 키로 삼는 것이다.
당연히 새로운 도큐먼트를 생성하면 maxKey를 가진 청크에 배정된다.
이런 특성때문에 한 샤드에 데이터가 몰리고, 특정 청크만 split을 하게되는 현상이 생긴다.
안타깝게도 몽고의 입장에서는 밸런스를 맞추기위해, 지속적으로 재분배를 해야하는 불편함이 생긴다고 한다.

Randomly Distributed Shard Keys
-
Randomly distributed key는 usernames, email addresses, UUIDs, MD5 hashes와 같이 특정 패턴을 예측하기 어려운 필드를 키로 삼는 것이다.
균등하게 데이커가 분배될테니 이점이 있다.
유일한 단점이라고 몽고는 RAM의 사이즈를 넘는 랜덤 데이터의 접근에는 퍼포먼스 이슈를 보이는 단점이 있다.

Location-Based Shard Keys
-
Location-based shard key는 IP, 위/경도, 주소와 같이 지리를 기반으로 한 필드를 키로 삼는 것이다.
하지만 반드시 물리적인 위치로 생각할 필요는 없고, 는리적으로 그룹을 생성할 수 있는 필드라고 하는 것이 조금 더 정확할 수 있다.

Shard Key Strategies
-
아래는 다양한 키 세팅의 전략들이다.

Hashed Shard Key
-
데이터를 빠르게 로드하려는 목적에 있어서는 해시드 샤드 키가 최고이다.
하지만 트레이드-오프로 타켓을 정한 레인지 쿼리는 할 수 없다.

The Firehose Strategy
-
만약에 보유한 서버 중, 특정 서버가 다른 서버보다 정말 너무 많이 뛰어나다면 해당 서버가 더 많은 로드를 감당하기를 원할 수 있다.
만약 강력한 서버가 빨리 처리한 뒤, 청크들을 재분배하는 전략을 사용한다면 여러 서버를 거치는 것보다 적은 지연의 효과를 볼 수 있다.

Ascending shard key에서 이런 전략을 사용하기 위해서는 강력한 서버의 청크를 가장 큰 청크로 고정하는 과정이 필요하다.
당연히 인서트되는 데이터는 끝에 몰릴것이고, 원하는 효과를 볼 수 있다.
단 주의해야할 점은 가장 큰 청크로 고정하는 과정에서 들어온 데이터가 묶여버리게 하면 안된다는 것이다.
예를 들어 24년 1월 1일-영원 이라는 범위를 가지고 키를 잡은 경우, 들어온 데이터가 해당 샤드에 묶여 분배되지 못할 수 있다.
이런 경우 크론-잡을 돌리던 어쩌던 방법을 사용해서 묶인 데이터가 다른 샤드에 쪼개질 수 있도록 범위를 재조정해줄 필요가 있다.
또 이 전략을 사용한 경우, 스케일링 시 어려움이 발생할 수 있으므로 잘 생각하자.

Multi-Hotspot
-
재미있는 사실은 Standalone mongod server에서는 ascending 쓰기 연산이 가장 효율적인 반면 샤드에서는 고르게 분산된 쓰기 연산이 효율적이라는 것이다.
Multi-Hotspot 전략은 여기서 아이디어를 얻었다.
분산은 골고루, 한 샤드안에서는 오름차순으로 쓰기 연산을 한다는 것이 핵심이다.
이를 달성하기 위해서는 컴파운드 키를 사용하여, 첫번째 컴파운드는 랜덤하게 두번째는 오름차순으로 생성하면 된다.

하지만 마찬가지로 오름차순을 사용한다는 점에서 샤드별로 성장할 수 있는 청크(핫스팟)에는 제한이 걸린다.
샤드별로 적절히 청크를 분배해야 효과를 볼 수 있다.

Shard Key Rules and Guidelines
-
아래는 샤드 키를 선택하기 이전에 고려해야할 제한들에 대해서 설명한다.
당연히 샤드 키와 인덱싱은 원리가 같으니 함께 고려해야한다.

1. 샤드 키는 어레이여서는 안된다. 뮤터블 타입(혹은 대부분의 특수 타입 들)의 경우에는 키로 삼기에는 워험하다.
2. 카디널리티가 높은 값을 키로 잡는 것이 좋다. 안좋다는대도 굳이 굳이 카디널리티가 낮은 키를 쓰고 싶다면 컴파운드로 걸어주자.
